# 第二部分 分布式的数据

对于一个成功的技术来说，真实必须优先于公关，因为自然无法被愚弄。

---

理查德·费曼，*罗杰斯委员会报告*（1986）

在本书的第一部分，我们讨论了当数据储存在单一设备上时适用的数据系统的各个方面。现在，在第二部分，我们拔高一个层级，问：多台设备参与数据的存储和获取时会发生什么？

想要把数据库分布到多个设备有许多理由：

*可扩展性*

如果数据量、读取负载或者写入负载增长到单台设备无法处理的水平，可以将负载分散到多台设备上。

*容错机制/高可用性*

如果即使在一台设备（或者几台设备，或者网络，或者整个数据中心）崩溃，你可以使用多台设备保证冗余度。当一台设备崩溃，另外一台可以立即接管。

*延迟*

如果用户遍布全球，你也许想要在世界不同地点架设服务器，使得每个用户可以就近被服务。这可以避免用户等待穿越了半个地球的网络数据包。

## 扩展以支持更高的负载

如果你只是需要扩展以支持更高的负载，最简单的方式是买一台更强筋的设备（这叫做*垂直扩展*或者*提升*）。许多CPU，许多内存芯片，以及许多磁盘可以用一个操作系统连接起来，而高速的互联使得CPU可以访问任意位置的内存或磁盘。在这种*共享内存架构*中，所有的组件加起来被当作是单个设备。

共享内存架构的问题是成本的增长超过了线性：一台有着两倍CPU，两倍内存，两倍磁盘空间的设备通常成本远远大于两倍。并且由于瓶颈问题，两倍体量的设备并不是一定可以处理两倍的负载的。

共享内存架构也只提供有限的容错机制——高端设备有热插拔组件（可以更换磁盘，内存模组甚至CPU而不关机）——但是这只限于单个物理位置。

另外一种方式是共享磁盘架构，它使用数台有着独立CPU和内存的设备，但是存储数据在设备间共享的磁盘阵列上，设备通过高速网络连接。这种架构可以用来处理某些数据仓库的负载，但是连接以及锁定的消耗限制了共享磁盘方式的扩展性。

### 无共享的架构

相比之下，无共享架构（也叫做*水平扩展*或者*拓展*）开始变得流行起来。在这种方式中，每台运行数据库软件的设备或者虚拟机被称为节点。每个截断独立地使用自己地CPU，内存以及磁盘。任何节点之间地协同都是利用传统网络，在软件这一层解决的。

无共享架构系统不需要任何特殊硬件，所以可以使用任意性价比高的设备。你还可以把数据分布到数个物理地区，为用户降低延迟，也可以撑过失去整个数据中心的危险。有了虚拟机的云部署，你不必运营在谷歌的量级：哪怕是小公司，一个多区域的分布式架构现在也是可行的。

在书的这一部分，我们聚焦于无共享架构——不是因为它们是每一个使用场景的最佳选择，而是因为它们需要你，一个开发者最慎重的考虑。如果你的数据分布在数个节点上，你需要注意在这样的分布式系统中发生的各种限制与权衡——数据库没有办法神奇地把这些隐藏起来。

虽然分布式无共享架构有许多优势，它通常也导致应用额外的复杂度，有些时候还限制了数据模型的表现力。在一些场景中，一个简单的单线程程序可以比有着超过100个CPU核心的簇执行地更好。另外一方面，无共享系统可以非常强大。接下来几章将深入到当数据分布化了之后产生的具体问题。

### 复制与分隔

有两种常见的方式将数据分布到多个节点：

*副本*

保存同样的数据拷贝在多个不同的节点上，可能在不同的地方。副本提供了冗余度：如果一些节点不可用，数据仍然可以从余下的节点提供。副本还可以帮助提升性能。我们会在第五章讨论副本。

*分库*

把一个大数据库拆分成小的子集叫做*分库*，于是不同的分库可以被制定到不同的节点（也叫做*分片*）。我们会在第六章讨论分库。

它们是独立的机制，但是它们经常同时出现，如图II-1所示：

*图II-1 数据库被拆分为两个分库，每个分库有两个副本*

对这些概念有了理解之后，我们就可以讨论在分布式系统中你需要做的困难的权衡。我们会在第七章讨论事务，这将帮助你理解所有在数据系统中可以出错的事，以及针对它们你可以做些什么。我们会通过在第八、九章讨论分布式系统的根本限制对本书这一部分进行总结。

稍后，在本书的第三部分，我们将讨论如何把几个（也许是分布式的）数据存储集成到更大的系统中，从而满足复杂应用的需要。但是首先，让我们聊一聊分布式的数据。